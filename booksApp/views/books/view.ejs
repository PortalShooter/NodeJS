<%- include('../partials/header.ejs') %> 

<div class="mb-5 pt-3 d-flex align-items-center justify-content-between">
    <h1><%= title %></h1>
    <div>
        <a class="btn btn-primary" href="/books/update/<%= book.id %>">
            Редактировать
        </a>
        <form action="/books/delete/<%= book.id %>" method="POST" class="d-inline">
            <button class="btn btn-primary btn-danger">
                Удалить
            </button>
        </form>
    </div>
</div>

<h2>Автор</h2>
<p><%= book.authors %> </p>
<h2>Описание</h2>
<p><%= book.description %> </p>

<h2 class="mt-5">Комментарии</h2>
<form id="form" method="POST" class="mt-1">

    <div class="form-group mb-3">
        <label for="userName">Как вас зовут?</label>
        <input type="text"
               name="userName"
               class="form-control"
               id="userName">
    </div>

    <div class="form-group mb-3">
        <label for="userComment">Комментарий</label>
        <textarea
                rows="3"
                name="userComment"
                class="form-control"
                id="userComment"
        ></textarea>
    </div>

    <div class="form-group text-right mb-5">
        <button type="submit" class="btn btn-primary">Отправить</button>
    </div>

</form>

<ul id="comments" class="list-group">

</ul>

<script src="/socket.io/socket.io.js"></script>
<script>
    const roomName = location.pathname.split('/').pop();
    const socket = io.connect('/', { query: `roomName=${roomName}`});
  
    const form = document.getElementById('form');
    const userName = document.getElementById('userName');
    const userComment = document.getElementById('userComment');
    const comments = document.getElementById('comments');
  
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      if (userName.value && userComment.value) {
        socket.emit('book-comment',{ userName: userName.value, userComment: userComment.value });
        userComment.value = '';
      }
    });

    socket.on('book-comment', ({userName, userComment}) => {
        const item = document.createElement('li');
        item.classList.add('list-group-item')
        comments.append(item)

        const name = document.createElement('strong');
        name.textContent = userName
        item.append(name)

        const comment = document.createElement('div');
        comment.textContent = userComment
        item.append(comment)
    })

</script>

<%- include('../partials/footer.ejs') %> 